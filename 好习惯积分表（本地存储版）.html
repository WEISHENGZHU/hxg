<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªæ€§åŒ–å¥½ä¹ æƒ¯ç§¯åˆ†è¡¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #6ecbf5 0%, #059ee3 100%);
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .password-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .password-form {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .password-form input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            width: 200px;
        }
        
        .password-form button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .password-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .password-actions button {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        #changePasswordBtn {
            background-color: #FF9800;
        }
        
        #lockBtn {
            background-color: #F44336;
        }
        
        .password-status {
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .locked {
            color: #F44336;
        }
        
        .unlocked {
            color: #4CAF50;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal h3 {
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }
        
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .modal-form input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            padding: 8px 20px;
        }
        
        .children-management {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .add-child-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .add-child-form input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            flex: 1;
            min-width: 150px;
        }
        
        .add-child-form button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .children-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .child-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background-color: #e3f2fd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .child-tab.active {
            background-color: #2196F3;
            color: white;
        }
        
        .child-name {
            font-weight: 500;
        }
        
        .edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .edit-btn:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .delete-btn:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .date-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .date-section label {
            font-weight: bold;
            color: #059ee3;
        }
        
        .date-section input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .points-summary {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .points-item {
            text-align: center;
        }
        
        .points-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .positive-points {
            color: #4CAF50;
        }
        
        .negative-points {
            color: #F44336;
        }
        
        .total-points {
            color: #059ee3;
        }
        
        .section {
            margin-bottom: 30px;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .section-header {
            padding: 15px 20px;
            font-size: 1.4rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .positive-section .section-header {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        
        .negative-section .section-header {
            background-color: #FFEBEE;
            color: #C62828;
        }
        
        .add-habit-btn {
            background-color: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .add-habit-btn:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        thead th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #555;
        }
        
        .habit-name {
            text-align: left;
            font-weight: 500;
        }
        
        .points-cell {
            font-weight: bold;
            width: 80px;
        }
        
        .positive-points-cell {
            color: #4CAF50;
        }
        
        .negative-points-cell {
            color: #F44336;
        }
        
        .check-cell {
            width: 40px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .habit-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .habit-edit-btn, .habit-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .habit-edit-btn:hover, .habit-delete-btn:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #resetBtn {
            background-color: #FFC107;
            color: #333;
        }
        
        #resetBtn:hover {
            background-color: #FFB300;
        }
        
        #printBtn {
            background-color: #4CAF50;
            color: white;
        }
        
        #printBtn:hover {
            background-color: #45a049;
        }
        
        .child-scoreboard {
            display: none;
        }
        
        .child-scoreboard.active {
            display: block;
        }
        
        .edit-form {
            display: none;
            align-items: center;
            gap: 5px;
        }
        
        .edit-form input {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .edit-form button {
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        
        .habit-edit-form {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .habit-edit-form input {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 120px;
        }
        
        .habit-edit-form input.points-input {
            width: 60px;
        }
        
        .locked-overlay {
            position: relative;
        }
        
        .locked-overlay::after {
            content: "ğŸ”’ éœ€è¦å®¶é•¿å¯†ç æ‰èƒ½ä¿®æ”¹";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #F44336;
            border-radius: 12px;
            z-index: 10;
        }
        
        .view-only .edit-btn,
        .view-only .delete-btn,
        .view-only .add-habit-btn,
        .view-only .habit-edit-btn,
        .view-only .habit-delete-btn,
        .view-only #addChildBtn,
        .view-only #resetBtn {
            display: none !important;
        }
        
        .quick-view {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .child-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            flex: 1;
            min-width: 200px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .child-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .child-card.active {
            border: 2px solid #2196F3;
        }
        
        .child-card h3 {
            margin-bottom: 10px;
            color: #2196F3;
        }
        
        .child-points {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .child-habits {
            font-size: 0.9rem;
            color: #666;
        }
        
        .storage-status {
            text-align: center;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #666;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            .actions, .date-section, .children-management, .add-habit-btn, .habit-actions, .password-section, .quick-view, .storage-status {
                display: none;
            }
            
            .section {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .child-scoreboard {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ä¸ªæ€§åŒ–å¥½ä¹ æƒ¯ç§¯åˆ†è¡¨</h1>
        <p>æ¿€åŠ±å­©å­å…»æˆè‰¯å¥½ä¹ æƒ¯çš„ä¸ªæ€§åŒ–æ‰“å¡ç³»ç»Ÿ</p>
    </header>
    
    <div class="password-section">
        <h3>å®¶é•¿å¯†ç ä¿æŠ¤</h3>
        <div class="password-form">
            <input type="password" id="parentPassword" placeholder="è¯·è¾“å…¥å®¶é•¿å¯†ç ">
            <button id="unlockBtn">è§£é”</button>
            <button id="lockBtn" style="display:none;">é”å®š</button>
        </div>
        <div class="password-actions">
            <button id="changePasswordBtn">ä¿®æ”¹å¯†ç </button>
        </div>
        <div class="password-status locked" id="passwordStatus">ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œå¯ä»¥æŸ¥çœ‹ä½†ä¸èƒ½ä¿®æ”¹</div>
    </div>
    
    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <h3>ä¿®æ”¹å®¶é•¿å¯†ç </h3>
            <div class="modal-form">
                <input type="password" id="currentPassword" placeholder="å½“å‰å¯†ç ">
                <input type="password" id="newPassword" placeholder="æ–°å¯†ç ">
                <input type="password" id="confirmPassword" placeholder="ç¡®è®¤æ–°å¯†ç ">
            </div>
            <div class="modal-buttons">
                <button id="savePasswordBtn">ä¿å­˜</button>
                <button id="cancelPasswordBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- å¿«é€ŸæŸ¥çœ‹å„¿ç«¥ç§¯åˆ†å¡ç‰‡ -->
    <div class="quick-view" id="quickView">
        <!-- å„¿ç«¥å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
    </div>
    
    <div class="children-management">
        <h2>å„¿ç«¥ç®¡ç†</h2>
        <div class="add-child-form">
            <input type="text" id="childName" placeholder="è¾“å…¥å„¿ç«¥å§“å">
            <button id="addChildBtn">æ·»åŠ å„¿ç«¥</button>
        </div>
        <div class="children-list" id="childrenList">
            <!-- å„¿ç«¥æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
        </div>
    </div>
    
    <div id="scoreboardsContainer">
        <!-- å„¿ç«¥ç§¯åˆ†è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
    </div>

    <script>
        // å®¶é•¿å¯†ç è®¾ç½® - ä½¿ç”¨localStorageå­˜å‚¨
        let parentPassword = localStorage.getItem('parentPassword') || "123456"; // é»˜è®¤å¯†ç 
        
        // ç³»ç»Ÿé”å®šçŠ¶æ€
        let isUnlocked = false;
        
        // å„¿ç«¥æ•°æ®å­˜å‚¨ - ä»localStorageåŠ è½½æˆ–ä½¿ç”¨é»˜è®¤å€¼
        let children = JSON.parse(localStorage.getItem('childrenData')) || [];
        
        // å®šä¹‰é»˜è®¤å¥½ä¹ æƒ¯å’Œä¸è‰¯è¡Œä¸º
        const defaultPositiveHabits = [
            { name: "æŒ‰æ—¶å®Œæˆä½œä¸š", points: 3 },
            { name: "æ•´ç†è‡ªå·±çš„æˆ¿é—´", points: 2 },
            { name: "ä¸»åŠ¨å¸®åŠ©åšå®¶åŠ¡", points: 4 },
            { name: "é˜…è¯»30åˆ†é’Ÿ", points: 3 },
            { name: "æŒ‰æ—¶ç¡è§‰", points: 2 }
        ];
        
        const defaultNegativeHabits = [
            { name: "ä¹±å‘è„¾æ°”", points: -5 },
            { name: "é•¿æ—¶é—´ç©ç”µå­è®¾å¤‡", points: -3 },
            { name: "ä¸æŒ‰æ—¶åƒé¥­", points: -2 },
            { name: "ä¸å…„å¼Ÿå§å¦¹äº‰åµ", points: -4 }
        ];
        
        // ä¿å­˜æ•°æ®åˆ°localStorage
        function saveData() {
            localStorage.setItem('childrenData', JSON.stringify(children));
            localStorage.setItem('parentPassword', parentPassword);
            updateStorageStatus();
        }
        
        // æ›´æ–°å­˜å‚¨çŠ¶æ€æ˜¾ç¤º
        function updateStorageStatus() {
            const status = document.getElementById('storageStatus');
            if (!status) {
                const newStatus = document.createElement('div');
                newStatus.className = 'storage-status';
                newStatus.id = 'storageStatus';
                newStatus.textContent = 'âœ… æ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°';
                document.body.appendChild(newStatus);
            }
        }
        
        // åŠ è½½æ‰“å¡è®°å½•
        function loadCheckboxStates(childId) {
            const savedStates = JSON.parse(localStorage.getItem(`checkboxStates_${childId}`)) || {};
            
            Object.keys(savedStates).forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = savedStates[checkboxId];
                }
            });
            
            // é‡æ–°è®¡ç®—ç§¯åˆ†
            if (childId) {
                calculatePoints(childId);
            }
        }
        
        // ä¿å­˜æ‰“å¡è®°å½•
        function saveCheckboxState(checkbox) {
            const childId = checkbox.getAttribute('data-child');
            const day = checkbox.getAttribute('data-day');
            const habitName = checkbox.closest('tr').querySelector('.habit-name').textContent;
            const checkboxId = `checkbox_${childId}_${habitName}_${day}`;
            
            checkbox.id = checkboxId;
            
            const savedStates = JSON.parse(localStorage.getItem(`checkboxStates_${childId}`)) || {};
            savedStates[checkboxId] = checkbox.checked;
            localStorage.setItem(`checkboxStates_${childId}`, JSON.stringify(savedStates));
        }
        
        // è§£é”æŒ‰é’®äº‹ä»¶
        document.getElementById('unlockBtn').addEventListener('click', function() {
            const password = document.getElementById('parentPassword').value;
            if (password === parentPassword) {
                isUnlocked = true;
                updateLockStatus();
                document.getElementById('parentPassword').value = '';
            } else {
                alert('å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥');
                document.getElementById('parentPassword').value = '';
                document.getElementById('parentPassword').focus();
            }
        });
        
        // é”å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('lockBtn').addEventListener('click', function() {
            isUnlocked = false;
            updateLockStatus();
        });
        
        // ä¿®æ”¹å¯†ç æŒ‰é’®äº‹ä»¶
        document.getElementById('changePasswordBtn').addEventListener('click', function() {
            if (!isUnlocked) {
                alert('è¯·å…ˆè§£é”ç³»ç»Ÿ');
                return;
            }
            document.getElementById('changePasswordModal').style.display = 'flex';
        });
        
        // ä¿å­˜å¯†ç æŒ‰é’®äº‹ä»¶
        document.getElementById('savePasswordBtn').addEventListener('click', function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (currentPassword !== parentPassword) {
                alert('å½“å‰å¯†ç é”™è¯¯');
                return;
            }
            
            if (newPassword.length < 4) {
                alert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº4ä½');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            parentPassword = newPassword;
            saveData();
            alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            closePasswordModal();
        });
        
        // å–æ¶ˆä¿®æ”¹å¯†ç 
        document.getElementById('cancelPasswordBtn').addEventListener('click', function() {
            closePasswordModal();
        });
        
        // å…³é—­å¯†ç ä¿®æ”¹æ¨¡æ€æ¡†
        function closePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        // æ›´æ–°é”å®šçŠ¶æ€
        function updateLockStatus() {
            const unlockBtn = document.getElementById('unlockBtn');
            const lockBtn = document.getElementById('lockBtn');
            const status = document.getElementById('passwordStatus');
            
            if (isUnlocked) {
                unlockBtn.style.display = 'none';
                lockBtn.style.display = 'inline-block';
                status.textContent = 'ğŸ”“ ç³»ç»Ÿå·²è§£é”ï¼Œå¯ä»¥ä¿®æ”¹å†…å®¹';
                status.className = 'password-status unlocked';
                
                // ç§»é™¤é”å®šè¦†ç›–å±‚å’Œåªè¯»ç±»
                document.querySelectorAll('.locked-overlay').forEach(el => {
                    el.classList.remove('locked-overlay');
                });
                document.body.classList.remove('view-only');
            } else {
                unlockBtn.style.display = 'inline-block';
                lockBtn.style.display = 'none';
                status.textContent = 'ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œå¯ä»¥æŸ¥çœ‹ä½†ä¸èƒ½ä¿®æ”¹';
                status.className = 'password-status locked';
                
                // æ·»åŠ åªè¯»ç±»ï¼Œéšè—ç¼–è¾‘æŒ‰é’®
                document.body.classList.add('view-only');
            }
        }
        
        // æ£€æŸ¥æƒé™
        function checkPermission() {
            if (!isUnlocked) {
                alert('éœ€è¦å®¶é•¿å¯†ç æ‰èƒ½è¿›è¡Œæ­¤æ“ä½œ');
                return false;
            }
            return true;
        }
        
        // æ·»åŠ å„¿ç«¥åŠŸèƒ½
        document.getElementById('addChildBtn').addEventListener('click', function() {
            if (!checkPermission()) return;
            
            const childName = document.getElementById('childName').value.trim();
            if (childName) {
                addChild(childName);
                document.getElementById('childName').value = '';
            } else {
                alert('è¯·è¾“å…¥å„¿ç«¥å§“å');
            }
        });
        
        // æ·»åŠ å„¿ç«¥
        function addChild(name) {
            const child = {
                id: Date.now().toString(),
                name: name,
                habits: {
                    positive: JSON.parse(JSON.stringify(defaultPositiveHabits)),
                    negative: JSON.parse(JSON.stringify(defaultNegativeHabits))
                }
            };
            
            children.push(child);
            saveData();
            renderChildrenTabs();
            renderQuickView();
            renderChildScoreboard(child);
            switchToChild(child.id);
        }
        
        // æ¸²æŸ“å¿«é€ŸæŸ¥çœ‹å¡ç‰‡
        function renderQuickView() {
            const quickView = document.getElementById('quickView');
            quickView.innerHTML = '';
            
            children.forEach(child => {
                const card = document.createElement('div');
                card.className = 'child-card';
                card.dataset.childId = child.id;
                
                // è®¡ç®—å½“å‰ç§¯åˆ†
                const totalPoints = calculateChildPoints(child.id);
                
                card.innerHTML = `
                    <h3>${child.name}</h3>
                    <div class="child-points" style="color: ${totalPoints >= 0 ? '#4CAF50' : '#F44336'}">
                        ${totalPoints >= 0 ? '+' : ''}${totalPoints}åˆ†
                    </div>
                    <div class="child-habits">
                        ${child.habits.positive.length}ä¸ªå¥½ä¹ æƒ¯ | ${child.habits.negative.length}ä¸ªåä¹ æƒ¯
                    </div>
                `;
                
                card.addEventListener('click', function() {
                    switchToChild(child.id);
                });
                
                quickView.appendChild(card);
            });
        }
        
        // æ¸²æŸ“å„¿ç«¥æ ‡ç­¾
        function renderChildrenTabs() {
            const childrenList = document.getElementById('childrenList');
            childrenList.innerHTML = '';
            
            children.forEach(child => {
                const tab = document.createElement('div');
                tab.className = 'child-tab';
                tab.dataset.childId = child.id;
                
                tab.innerHTML = `
                    <span class="child-name">${child.name}</span>
                    <button class="edit-btn" title="ç¼–è¾‘å§“å">âœï¸</button>
                    <button class="delete-btn" title="åˆ é™¤å„¿ç«¥">ğŸ—‘ï¸</button>
                `;
                
                // ç¼–è¾‘æŒ‰é’®äº‹ä»¶
                const editBtn = tab.querySelector('.edit-btn');
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (!checkPermission()) return;
                    startEditingChild(child.id);
                });
                
                // åˆ é™¤æŒ‰é’®äº‹ä»¶
                const deleteBtn = tab.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (!checkPermission()) return;
                    deleteChild(child.id);
                });
                
                // åˆ‡æ¢å„¿ç«¥äº‹ä»¶
                tab.addEventListener('click', function() {
                    switchToChild(child.id);
                });
                
                childrenList.appendChild(tab);
            });
        }
        
        // å¼€å§‹ç¼–è¾‘å„¿ç«¥å§“å
        function startEditingChild(childId) {
            const tab = document.querySelector(`.child-tab[data-child-id="${childId}"]`);
            const childNameSpan = tab.querySelector('.child-name');
            const currentName = childNameSpan.textContent;
            
            // åˆ›å»ºç¼–è¾‘è¡¨å•
            const editForm = document.createElement('div');
            editForm.className = 'edit-form';
            editForm.innerHTML = `
                <input type="text" value="${currentName}">
                <button class="save-btn">ä¿å­˜</button>
                <button class="cancel-btn">å–æ¶ˆ</button>
            `;
            
            // æ›¿æ¢æ˜¾ç¤ºå†…å®¹
            childNameSpan.style.display = 'none';
            tab.querySelector('.edit-btn').style.display = 'none';
            tab.querySelector('.delete-btn').style.display = 'none';
            tab.insertBefore(editForm, childNameSpan);
            
            // ä¿å­˜æŒ‰é’®äº‹ä»¶
            const saveBtn = editForm.querySelector('.save-btn');
            saveBtn.addEventListener('click', function() {
                const newName = editForm.querySelector('input').value.trim();
                if (newName) {
                    updateChildName(childId, newName);
                } else {
                    alert('å§“åä¸èƒ½ä¸ºç©º');
                }
            });
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            const cancelBtn = editForm.querySelector('.cancel-btn');
            cancelBtn.addEventListener('click', function() {
                cancelEditingChild(childId);
            });
            
            // å›è½¦ä¿å­˜
            editForm.querySelector('input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveBtn.click();
                }
            });
            
            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            editForm.querySelector('input').focus();
        }
        
        // æ›´æ–°å„¿ç«¥å§“å
        function updateChildName(childId, newName) {
            const child = children.find(c => c.id === childId);
            if (child) {
                child.name = newName;
                saveData();
                renderChildrenTabs();
                renderQuickView();
                // é‡æ–°åˆ‡æ¢åˆ°å½“å‰å„¿ç«¥
                switchToChild(childId);
            }
        }
        
        // å–æ¶ˆç¼–è¾‘
        function cancelEditingChild(childId) {
            renderChildrenTabs();
            // é‡æ–°åˆ‡æ¢åˆ°å½“å‰å„¿ç«¥
            switchToChild(childId);
        }
        
        // åˆ é™¤å„¿ç«¥
        function deleteChild(childId) {
            if (children.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå„¿ç«¥');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå„¿ç«¥å—ï¼Ÿ')) {
                children = children.filter(child => child.id !== childId);
                saveData();
                renderChildrenTabs();
                renderQuickView();
                
                // åˆ é™¤å¯¹åº”çš„ç§¯åˆ†è¡¨
                const scoreboard = document.getElementById(`scoreboard-${childId}`);
                if (scoreboard) {
                    scoreboard.remove();
                }
                
                // åˆ é™¤å¯¹åº”çš„æ‰“å¡è®°å½•
                localStorage.removeItem(`checkboxStates_${childId}`);
                
                // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªå„¿ç«¥
                if (children.length > 0) {
                    switchToChild(children[0].id);
                }
            }
        }
        
        // åˆ‡æ¢åˆ°æŒ‡å®šå„¿ç«¥
        function switchToChild(childId) {
            // æ›´æ–°å¡ç‰‡çŠ¶æ€
            document.querySelectorAll('.child-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`.child-card[data-child-id="${childId}"]`).classList.add('active');
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.child-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.child-tab[data-child-id="${childId}"]`).classList.add('active');
            
            // æ›´æ–°ç§¯åˆ†è¡¨æ˜¾ç¤º
            document.querySelectorAll('.child-scoreboard').forEach(scoreboard => {
                scoreboard.classList.remove('active');
            });
            const targetScoreboard = document.getElementById(`scoreboard-${childId}`);
            if (targetScoreboard) {
                targetScoreboard.classList.add('active');
            }
        }
        
        // è®¡ç®—å„¿ç«¥ç§¯åˆ†
        function calculateChildPoints(childId) {
            let positivePoints = 0;
            let negativePoints = 0;
            
            // è®¡ç®—åŠ åˆ†é¡¹
            const positiveCheckboxes = document.querySelectorAll(`#positiveHabits-${childId} input[type="checkbox"]:checked`);
            positiveCheckboxes.forEach(checkbox => {
                positivePoints += parseInt(checkbox.getAttribute('data-points'));
            });
            
            // è®¡ç®—å‡åˆ†é¡¹
            const negativeCheckboxes = document.querySelectorAll(`#negativeHabits-${childId} input[type="checkbox"]:checked`);
            negativeCheckboxes.forEach(checkbox => {
                negativePoints += parseInt(checkbox.getAttribute('data-points'));
            });
            
            return positivePoints + negativePoints;
        }
        
        // æ¸²æŸ“å„¿ç«¥ç§¯åˆ†è¡¨
        function renderChildScoreboard(child) {
            const scoreboardsContainer = document.getElementById('scoreboardsContainer');
            
            // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤
            const existingScoreboard = document.getElementById(`scoreboard-${child.id}`);
            if (existingScoreboard) {
                existingScoreboard.remove();
            }
            
            const scoreboard = document.createElement('div');
            scoreboard.className = 'child-scoreboard';
            scoreboard.id = `scoreboard-${child.id}`;
            
            scoreboard.innerHTML = `
                <div class="date-section">
                    <label for="recordDate-${child.id}">è®°å½•æ—¥æœŸï¼š</label>
                    <input type="date" id="recordDate-${child.id}">
                </div>
                
                <div class="points-summary">
                    <div class="points-item">
                        <div class="points-label">æœ¬å‘¨æ€»åˆ†</div>
                        <div class="points-value total-points" id="totalPoints-${child.id}">0</div>
                    </div>
                    <div class="points-item">
                        <div class="points-label">åŠ åˆ†é¡¹</div>
                        <div class="points-value positive-points" id="positivePoints-${child.id}">0</div>
                    </div>
                    <div class="points-item">
                        <div class="points-label">å‡åˆ†é¡¹</div>
                        <div class="points-value negative-points" id="negativePoints-${child.id}">0</div>
                    </div>
                </div>
                
                <div class="section positive-section">
                    <div class="section-header">
                        <span>ä¸€ã€åŠ åˆ†å¥–åŠ± ğŸŒŸ</span>
                        <button class="add-habit-btn" data-type="positive" data-child="${child.id}">+ æ·»åŠ å¥½ä¹ æƒ¯</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="habit-name">å¥½ä¹ æƒ¯</th>
                                    <th class="points-cell">ç§¯åˆ†</th>
                                    <th>å‘¨ä¸€</th>
                                    <th>å‘¨äºŒ</th>
                                    <th>å‘¨ä¸‰</th>
                                    <th>å‘¨å››</th>
                                    <th>å‘¨äº”</th>
                                    <th>å‘¨å…­</th>
                                    <th>å‘¨æ—¥</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="positiveHabits-${child.id}">
                                <!-- å¥½ä¹ æƒ¯è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="section negative-section">
                    <div class="section-header">
                        <span>äºŒã€å‡åˆ†æƒ©ç½š ğŸ˜ </span>
                        <button class="add-habit-btn" data-type="negative" data-child="${child.id}">+ æ·»åŠ åä¹ æƒ¯</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="habit-name">ä¸è‰¯è¡Œä¸º</th>
                                    <th class="points-cell">ç§¯åˆ†</th>
                                    <th>å‘¨ä¸€</th>
                                    <th>å‘¨äºŒ</th>
                                    <th>å‘¨ä¸‰</th>
                                    <th>å‘¨å››</th>
                                    <th>å‘¨äº”</th>
                                    <th>å‘¨å…­</th>
                                    <th>å‘¨æ—¥</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="negativeHabits-${child.id}">
                                <!-- ä¸è‰¯è¡Œä¸ºè¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            scoreboardsContainer.appendChild(scoreboard);
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            document.getElementById(`recordDate-${child.id}`).valueAsDate = new Date();
            
            // ç”Ÿæˆå¥½ä¹ æƒ¯è¡¨æ ¼è¡Œ
            renderHabitsTable(child.id, 'positive', child.habits.positive);
            
            // ç”Ÿæˆä¸è‰¯è¡Œä¸ºè¡¨æ ¼è¡Œ
            renderHabitsTable(child.id, 'negative', child.habits.negative);
            
            // ä¸ºæ·»åŠ ä¹ æƒ¯æŒ‰é’®æ·»åŠ äº‹ä»¶
            document.querySelectorAll(`#scoreboard-${child.id} .add-habit-btn`).forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!checkPermission()) return;
                    const type = this.getAttribute('data-type');
                    addNewHabit(child.id, type);
                });
            });
            
            // åŠ è½½ä¿å­˜çš„æ‰“å¡è®°å½•
            loadCheckboxStates(child.id);
        }
        
        // æ¸²æŸ“ä¹ æƒ¯è¡¨æ ¼
        function renderHabitsTable(childId, type, habits) {
            const tableBody = document.getElementById(`${type}Habits-${childId}`);
            tableBody.innerHTML = '';
            
            habits.forEach((habit, index) => {
                const row = document.createElement('tr');
                const pointsClass = type === 'positive' ? 'positive-points-cell' : 'negative-points-cell';
                const pointsDisplay = type === 'positive' ? `+${habit.points}` : habit.points;
                
                row.innerHTML = `
                    <td class="habit-name">${habit.name}</td>
                    <td class="points-cell ${pointsClass}">${pointsDisplay}</td>
                    <td class="check-cell"><input type="checkbox" data-points="${habit.points}" data-day="monday" data-child="${childId}"></td>
                    <td class="check-cell"><input type="checkbox" data-points="${habit.points}" data-day="tuesday" data-child="${childId}"></td>
                    <td class="check-cell"><input type="checkbox" data-points="${habit.points}" data-day="wednesday" data-child="${childId}"></td>
                    <td class="check-cell"><input type="checkbox" data-points="${habit.points}" data-day="thursday" data-child="${childId}"></td>
                    <td class="check-cell"><input type="checkbox" data-points="${habit.points}" data-day="friday" data-child="${childId}"></td>
                    <td class="check-cell"><input type="checkbox" data-points="${habit.points}" data-day="saturday" data-child="${childId}"></td>
                    <td class="check-cell"><input type="checkbox" data-points="${habit.points}" data-day="sunday" data-child="${childId}"></td>
                    <td class="habit-actions">
                        <button class="habit-edit-btn" title="ç¼–è¾‘ä¹ æƒ¯">âœï¸</button>
                        <button class="habit-delete-btn" title="åˆ é™¤ä¹ æƒ¯">ğŸ—‘ï¸</button>
                    </td>
                `;
                
                // ç¼–è¾‘æŒ‰é’®äº‹ä»¶
                const editBtn = row.querySelector('.habit-edit-btn');
                editBtn.addEventListener('click', function() {
                    if (!checkPermission()) return;
                    startEditingHabit(childId, type, index, habit);
                });
                
                // åˆ é™¤æŒ‰é’®äº‹ä»¶
                const deleteBtn = row.querySelector('.habit-delete-btn');
                deleteBtn.addEventListener('click', function() {
                    if (!checkPermission()) return;
                    deleteHabit(childId, type, index);
                });
                
                // å¤é€‰æ¡†äº‹ä»¶ - ä¸éœ€è¦å¯†ç ï¼Œä½†éœ€è¦ä¿å­˜çŠ¶æ€
                row.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        calculatePoints(childId);
                        // æ›´æ–°å¿«é€ŸæŸ¥çœ‹å¡ç‰‡
                        renderQuickView();
                        // ä¿å­˜æ‰“å¡çŠ¶æ€
                        saveCheckboxState(this);
                    });
                });
                
                tableBody.appendChild(row);
            });
        }
        
        // å¼€å§‹ç¼–è¾‘ä¹ æƒ¯
        function startEditingHabit(childId, type, index, habit) {
            const child = children.find(c => c.id === childId);
            if (!child) return;
            
            const tableBody = document.getElementById(`${type}Habits-${childId}`);
            const row = tableBody.children[index];
            
            // åˆ›å»ºç¼–è¾‘è¡¨å•
            const editForm = document.createElement('div');
            editForm.className = 'habit-edit-form';
            editForm.innerHTML = `
                <input type="text" value="${habit.name}" class="habit-name-input">
                <input type="number" value="${Math.abs(habit.points)}" class="points-input" min="1" max="10">
                <button class="save-habit-btn">ä¿å­˜</button>
                <button class="cancel-habit-btn">å–æ¶ˆ</button>
            `;
            
            // æ›¿æ¢æ˜¾ç¤ºå†…å®¹
            const nameCell = row.cells[0];
            const pointsCell = row.cells[1];
            const actionsCell = row.cells[9];
            
            const originalName = nameCell.innerHTML;
            const originalPoints = pointsCell.innerHTML;
            const originalActions = actionsCell.innerHTML;
            
            nameCell.innerHTML = '';
            nameCell.appendChild(editForm);
            
            pointsCell.style.display = 'none';
            actionsCell.style.display = 'none';
            
            // ä¿å­˜æŒ‰é’®äº‹ä»¶
            const saveBtn = editForm.querySelector('.save-habit-btn');
            saveBtn.addEventListener('click', function() {
                const newName = editForm.querySelector('.habit-name-input').value.trim();
                const newPoints = parseInt(editForm.querySelector('.points-input').value);
                
                if (newName && newPoints > 0) {
                    updateHabit(childId, type, index, newName, type === 'positive' ? newPoints : -newPoints);
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä¹ æƒ¯åç§°å’Œç§¯åˆ†');
                }
            });
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            const cancelBtn = editForm.querySelector('.cancel-habit-btn');
            cancelBtn.addEventListener('click', function() {
                nameCell.innerHTML = originalName;
                pointsCell.innerHTML = originalPoints;
                pointsCell.style.display = '';
                actionsCell.innerHTML = originalActions;
                actionsCell.style.display = '';
            });
            
            // å›è½¦ä¿å­˜
            editForm.querySelector('.habit-name-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveBtn.click();
                }
            });
            
            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            editForm.querySelector('.habit-name-input').focus();
        }
        
        // æ›´æ–°ä¹ æƒ¯
        function updateHabit(childId, type, index, newName, newPoints) {
            const child = children.find(c => c.id === childId);
            if (child) {
                child.habits[type][index].name = newName;
                child.habits[type][index].points = newPoints;
                saveData();
                renderHabitsTable(childId, type, child.habits[type]);
                calculatePoints(childId);
                renderQuickView();
            }
        }
        
        // åˆ é™¤ä¹ æƒ¯
        function deleteHabit(childId, type, index) {
            const child = children.find(c => c.id === childId);
            if (child) {
                if (child.habits[type].length <= 1) {
                    alert(`è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ª${type === 'positive' ? 'å¥½ä¹ æƒ¯' : 'åä¹ æƒ¯'}`);
                    return;
                }
                
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿ')) {
                    child.habits[type].splice(index, 1);
                    saveData();
                    renderHabitsTable(childId, type, child.habits[type]);
                    calculatePoints(childId);
                    renderQuickView();
                }
            }
        }
        
        // æ·»åŠ æ–°ä¹ æƒ¯
        function addNewHabit(childId, type) {
            const child = children.find(c => c.id === childId);
            if (child) {
                const defaultName = type === 'positive' ? 'æ–°å¥½ä¹ æƒ¯' : 'æ–°åä¹ æƒ¯';
                const defaultPoints = type === 'positive' ? 3 : -3;
                
                child.habits[type].push({
                    name: defaultName,
                    points: defaultPoints
                });
                
                saveData();
                renderHabitsTable(childId, type, child.habits[type]);
                calculatePoints(childId);
                renderQuickView();
            }
        }
        
        // è®¡ç®—æ€»åˆ†
        function calculatePoints(childId) {
            let positivePoints = 0;
            let negativePoints = 0;
            
            // è®¡ç®—åŠ åˆ†é¡¹
            const positiveCheckboxes = document.querySelectorAll(`#positiveHabits-${childId} input[type="checkbox"]:checked`);
            positiveCheckboxes.forEach(checkbox => {
                positivePoints += parseInt(checkbox.getAttribute('data-points'));
            });
            
            // è®¡ç®—å‡åˆ†é¡¹
            const negativeCheckboxes = document.querySelectorAll(`#negativeHabits-${childId} input[type="checkbox"]:checked`);
            negativeCheckboxes.forEach(checkbox => {
                negativePoints += parseInt(checkbox.getAttribute('data-points'));
            });
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById(`positivePoints-${childId}`).textContent = positivePoints;
            document.getElementById(`negativePoints-${childId}`).textContent = negativePoints;
            document.getElementById(`totalPoints-${childId}`).textContent = positivePoints + negativePoints;
        }
        
        // é‡ç½®æŒ‰é’®åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'resetBtn') {
                if (!checkPermission()) return;
                
                const activeChildId = document.querySelector('.child-tab.active').dataset.childId;
                if (confirm('ç¡®å®šè¦é‡ç½®æœ¬å‘¨çš„æ‰€æœ‰ç§¯åˆ†è®°å½•å—ï¼Ÿ')) {
                    document.querySelectorAll(`#scoreboard-${activeChildId} input[type="checkbox"]`).forEach(checkbox => {
                        checkbox.checked = false;
                        saveCheckboxState(checkbox);
                    });
                    calculatePoints(activeChildId);
                    renderQuickView();
                }
            }
        });
        
        // æ‰“å°æŒ‰é’®åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'printBtn') {
                window.print();
            }
        });
        
        // åˆå§‹åŒ–ï¼šå¦‚æœæœ‰ä¿å­˜çš„æ•°æ®ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ªå„¿ç«¥
        if (children.length > 0) {
            children.forEach(child => {
                renderChildScoreboard(child);
            });
            renderChildrenTabs();
            renderQuickView();
            switchToChild(children[0].id);
        } else {
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤å„¿ç«¥
            addChild('å°æ˜');
        }
        
        // åˆå§‹åŒ–é”å®šçŠ¶æ€
        updateLockStatus();
        
        // æ˜¾ç¤ºå­˜å‚¨çŠ¶æ€
        updateStorageStatus();
    </script>
    
    <div class="actions">
        <button id="resetBtn">é‡ç½®æœ¬å‘¨ç§¯åˆ†</button>
        <button id="printBtn">æ‰“å°è¡¨æ ¼</button>
    </div>
</body>
</html>