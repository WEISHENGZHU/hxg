<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸ªæ€§åŒ–å¥½ä¹ æƒ¯ç§¯åˆ†è¡¨ Â· GitHubæŒä¹…åŒ–å¢å¼ºç‰ˆ</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Helvetica Neue',Arial,sans-serif}
    body{background:#f8f9fa;color:#333;line-height:1.6;padding:20px;max-width:1200px;margin:0 auto}
    header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{padding:16px 20px;background:linear-gradient(135deg,#6ecbf5 0%,#059ee3 100%);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);color:#fff}
    h1{font-size:1.8rem}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .toolbar button,.toolbar label{padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:600;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .toolbar input[type=file]{display:none}
    .toolbar .primary{background:#059ee3;color:#fff}
    .toolbar .danger{background:#f44336;color:#fff}
    .toolbar .warning{background:#ff9800;color:#fff}
    .toolbar .success{background:#4caf50;color:#fff}

    .section-card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
    .password-form,.add-child-form{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .password-form input,.add-child-form input{padding:8px 12px;border:1px solid #ddd;border-radius:6px}

    .status{margin-top:8px;font-size:.9rem;color:#666}
    .status .ok{color:#4caf50}
    .status .warn{color:#ff9800}

    .children-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .child-tab{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#e3f2fd;border-radius:8px;cursor:pointer}
    .child-tab.active{background:#2196f3;color:#fff}
    .edit-btn,.delete-btn{border:none;background:none;font-size:.9rem;opacity:.75;cursor:pointer}

    .quick-view{display:flex;flex-wrap:wrap;gap:12px;margin:12px 0}
    .child-card{flex:1;min-width:200px;background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);padding:14px;text-align:center;cursor:pointer}
    .child-card.active{outline:2px solid #2196f3}

    .date-section,.points-summary{display:flex;gap:16px;align-items:center;justify-content:center;background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);padding:12px;margin:12px 0}
    .points-item{text-align:center}
    .points-value{font-size:1.6rem;font-weight:700}
    .positive-points{color:#4caf50}.negative-points{color:#f44336}.total-points{color:#059ee3}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;text-align:center;border-bottom:1px solid #eee}
    thead th{background:#f5f5f5;font-weight:600;color:#555}
    .habit-actions{display:flex;gap:6px;justify-content:center}

    .locked-overlay{position:relative}
    .locked-overlay::after{content:"ğŸ”’ éœ€è¦å®¶é•¿å¯†ç æ‰èƒ½ä¿®æ”¹";position:absolute;inset:0;background:rgba(255,255,255,.92);display:flex;align-items:center;justify-content:center;font-weight:700;color:#f44336;border-radius:12px}
    .view-only .edit-btn,.view-only .delete-btn,.view-only .add-habit-btn,.view-only .habit-edit-btn,.view-only .habit-delete-btn,.view-only #addChildBtn,.view-only #resetBtn{display:none!important}

    .storage-status{text-align:center;margin-top:6px;font-size:.85rem;color:#666}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:100}
    .modal-content{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.15);padding:20px;max-width:520px;width:92%}
    .modal h3{margin-bottom:10px}
    .modal .list{max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:8px}
    .modal .list table{width:100%}

    @media print{.toolbar,.password-area,.children-management,.quick-view,.storage-status,.actions{display:none}.section-card{box-shadow:none;border:1px solid #ddd}}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1>ä¸ªæ€§åŒ–å¥½ä¹ æƒ¯ç§¯åˆ†è¡¨</h1>
      <div>æ¿€åŠ±å­©å­å…»æˆè‰¯å¥½ä¹ æƒ¯çš„ä¸ªæ€§åŒ–æ‰“å¡ç³»ç»Ÿ Â· å«å†å²å½’æ¡£ä¸å¯¼å‡º</div>
    </div>
    <div class="toolbar" aria-label="æ•°æ®å·¥å…·">
      <button id="btnExport" class="primary">å¯¼å‡ºJSON</button>
      <label for="fileImport" class="success" title="ä»JSONå¯¼å…¥">å¯¼å…¥JSON</label>
      <input id="fileImport" type="file" accept="application/json" />
      <button id="btnArchive" class="warning" title="å°†æœ¬å‘¨å¿«ç…§å½’æ¡£">å½’æ¡£æœ¬å‘¨</button>
      <button id="btnHistory">æŸ¥çœ‹å†å²</button>
      <button id="btnShare">ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
      <button id="btnClear" class="danger">æ¸…ç©ºæ•°æ®</button>

      <!-- GitHub Gist -->
      <input id="gistId" type="text" placeholder="Gist ID" style="padding:10px 12px;border:1px solid #ddd;border-radius:8px;min-width:220px"/>
      <button id="btnSetToken">GitHub Token</button>
      <button id="btnSaveGist" class="primary">ä¿å­˜åˆ°Gist</button>
      <button id="btnLoadGist">ä»GiståŠ è½½</button>

      <!-- Google Drive -->
      <button id="btnGoogleClient">Google ClientID</button>
      <button id="btnGoogleSignIn">ç™»å½•Google</button>
      <button id="btnGoogleSignOut">é€€å‡º</button>
      <button id="btnSaveDrive" class="primary">ä¿å­˜åˆ°Drive</button>
      <button id="btnLoadDrive">ä»DriveåŠ è½½</button>

      <!-- Microsoft OneDrive -->
      <button id="btnMsClient">Microsoft ClientID</button>
      <button id="btnMsSignIn">ç™»å½•å¾®è½¯</button>
      <button id="btnMsSignOut">é€€å‡º</button>
      <button id="btnSaveOneDrive" class="primary">ä¿å­˜åˆ°OneDrive</button>
      <button id="btnLoadOneDrive">ä»OneDriveåŠ è½½</button>
    </div>
  </header>

  <section class="section-card password-area">
    <h2>å®¶é•¿å¯†ç ä¿æŠ¤</h2>
    <div class="password-form" style="margin-top:10px">
      <input type="password" id="parentPassword" placeholder="è¯·è¾“å…¥å®¶é•¿å¯†ç " />
      <button id="unlockBtn" class="success">è§£é”</button>
      <button id="lockBtn" style="display:none" class="danger">é”å®š</button>
      <button id="changePasswordBtn">ä¿®æ”¹å¯†ç </button>
    </div>
    <div class="status" id="passwordStatus">ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œå¯ä»¥æŸ¥çœ‹ä½†ä¸èƒ½ä¿®æ”¹</div>
  </section>

  <section class="section-card">
    <h2>å„¿ç«¥ç®¡ç†</h2>
    <div class="add-child-form" style="margin:10px 0 6px">
      <input type="text" id="childName" placeholder="è¾“å…¥å„¿ç«¥å§“å" />
      <button id="addChildBtn" class="success">æ·»åŠ å„¿ç«¥</button>
    </div>
    <div class="children-list" id="childrenList"></div>
  </section>

  <div class="quick-view" id="quickView"></div>
  <div id="scoreboardsContainer"></div>

  <!-- GitHub Token å¼¹çª— -->
  <div class="modal" id="tokenModal">
    <div class="modal-content">
      <h3>è®¾ç½® GitHub Token</h3>
      <div style="font-size:.9rem;color:#666;margin:6px 0 10px">ä»…éœ€å‹¾é€‰ <strong>gist</strong> æƒé™çš„ Personal Access Tokenã€‚ä»¤ç‰Œå°†ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ã€‚</div>
      <input type="password" id="ghTokenInput" placeholder="ç²˜è´´ä½ çš„ GitHub Token" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"/>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="btnSaveToken" class="success">ä¿å­˜</button>
        <button id="btnClearToken" class="danger">æ¸…é™¤</button>
        <button id="btnCloseToken">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- å†å²å½’æ¡£å¼¹çª— -->
  <div class="modal" id="historyModal">
    <div class="modal-content">
      <h3>å†å²å½’æ¡£</h3>
      <div class="list">
        <table>
          <thead><tr><th>å‘¨èµ·å§‹æ—¥</th><th>å„¿ç«¥</th><th>æ€»åˆ†</th><th>è¯¦æƒ…</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="btnCloseHistory">å…³é—­</button>
        <button id="btnExportHistory" class="primary">å¯¼å‡ºå½’æ¡£JSON</button>
      </div>
    </div>
  </div>

  <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
  <div class="modal" id="changePasswordModal">
    <div class="modal-content">
      <h3>ä¿®æ”¹å®¶é•¿å¯†ç </h3>
      <div style="display:flex;flex-direction:column;gap:10px">
        <input type="password" id="currentPassword" placeholder="å½“å‰å¯†ç " />
        <input type="password" id="newPassword" placeholder="æ–°å¯†ç ï¼ˆâ‰¥4ä½ï¼‰" />
        <input type="password" id="confirmPassword" placeholder="ç¡®è®¤æ–°å¯†ç " />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="savePasswordBtn" class="success">ä¿å­˜</button>
        <button id="cancelPasswordBtn">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <div class="storage-status" id="storageStatus">âœ… æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨ï¼ˆGitHub Pages åŒæ ·ç”Ÿæ•ˆï¼‰</div>

  <div class="actions" style="display:flex;gap:12px;justify-content:center;margin:16px 0">
    <button id="resetBtn" class="warning">é‡ç½®æœ¬å‘¨ç§¯åˆ†</button>
    <button id="printBtn" class="success">æ‰“å°è¡¨æ ¼</button>
  </div>

  <script>
  // ====== å­˜å‚¨å‘½åç©ºé—´ä¸å·¥å…· ======
  const NS = 'habit_v2';
  const KEY = (k) => `${NS}:${k}`;
  const GH_TOKEN_KEY = KEY('gh_token');
  const GH_GIST_ID_KEY = KEY('gh_gist_id');

  function safeGet(k, def){
    try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def }catch(e){ console.warn('parse fail',k,e); return def }
  }
  function safeSet(k, v){
    try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){ alert('æœ¬åœ°å­˜å‚¨ç©ºé—´ä¸è¶³æˆ–è¢«ç¦ç”¨'); console.error(e) }
  }
  function download(filename, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type:'application/json'}));
    a.download = filename; a.click(); URL.revokeObjectURL(a.href);
  }
  function isoWeekStart(d=new Date()){
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const day = date.getUTCDay() || 7; // å‘¨ä¸€ä¸º1
    if(day !== 1) date.setUTCDate(date.getUTCDate() - (day - 1));
    return date.toISOString().slice(0,10);
  }

  // ====== åˆå§‹æ•°æ® ======
  let parentPassword = localStorage.getItem(KEY('parentPassword')) || '123456';
  let isUnlocked = false;
  let children = safeGet(KEY('children'), []);
  let archives = safeGet(KEY('archives'), []); // [{weekStart:'YYYY-MM-DD', snapshot:{children:[{id,name,total,positive,negative}], raw:{children,checkbox}}}]

  const defaultPositive = [
    { name: 'æŒ‰æ—¶å®Œæˆä½œä¸š', points: 3 },
    { name: 'æ•´ç†è‡ªå·±çš„æˆ¿é—´', points: 2 },
    { name: 'ä¸»åŠ¨å¸®åŠ©åšå®¶åŠ¡', points: 4 },
    { name: 'é˜…è¯»30åˆ†é’Ÿ', points: 3 },
    { name: 'æŒ‰æ—¶ç¡è§‰', points: 2 },
  ];
  const defaultNegative = [
    { name: 'ä¹±å‘è„¾æ°”', points: -5 },
    { name: 'é•¿æ—¶é—´ç©ç”µå­è®¾å¤‡', points: -3 },
    { name: 'ä¸æŒ‰æ—¶åƒé¥­', points: -2 },
    { name: 'ä¸å…„å¼Ÿå§å¦¹äº‰åµ', points: -4 },
  ];

  function saveAll(){
    safeSet(KEY('children'), children);
    localStorage.setItem(KEY('parentPassword'), parentPassword);
    safeSet(KEY('archives'), archives);
    document.getElementById('storageStatus').textContent = 'âœ… æ•°æ®å·²ä¿å­˜';
  }

  // å¤é€‰æ¡†çŠ¶æ€ç‹¬ç«‹å­˜å‚¨ï¼ŒæŒ‰ childId åˆ†æ¡¶
  function loadChecks(childId){
    const m = safeGet(KEY('checks:' + childId), {});
    Object.keys(m).forEach(id => { const el = document.getElementById(id); if(el) el.checked = !!m[id]; });
    updateTotals(childId);
  }
  function saveCheck(checkbox){
    const childId = checkbox.getAttribute('data-child');
    const map = safeGet(KEY('checks:' + childId), {});
    map[checkbox.id] = checkbox.checked; safeSet(KEY('checks:' + childId), map);
  }

  // ====== å¯†ç ä¸é”å®š ======
  function updateLock(){
    const status = document.getElementById('passwordStatus');
    const unlockBtn = document.getElementById('unlockBtn');
    const lockBtn = document.getElementById('lockBtn');
    if(isUnlocked){
      status.textContent = 'ğŸ”“ ç³»ç»Ÿå·²è§£é”ï¼Œå¯ä»¥ä¿®æ”¹å†…å®¹';
      unlockBtn.style.display = 'none'; lockBtn.style.display = 'inline-block';
      document.body.classList.remove('view-only');
    }else{
      status.textContent = 'ğŸ”’ ç³»ç»Ÿå·²é”å®šï¼Œå¯ä»¥æŸ¥çœ‹ä½†ä¸èƒ½ä¿®æ”¹';
      unlockBtn.style.display = 'inline-block'; lockBtn.style.display = 'none';
      document.body.classList.add('view-only');
    }
  }
  function needAuth(){ if(!isUnlocked){ alert('éœ€è¦å®¶é•¿å¯†ç '); return true } return false }

  document.getElementById('unlockBtn').onclick = () => {
    const pwd = document.getElementById('parentPassword').value;
    if(pwd === parentPassword){ isUnlocked = true; updateLock(); document.getElementById('parentPassword').value=''; }
    else{ alert('å¯†ç é”™è¯¯'); }
  };
  document.getElementById('lockBtn').onclick = () => { isUnlocked = false; updateLock(); };

  document.getElementById('changePasswordBtn').onclick = () => {
    if(needAuth()) return; document.getElementById('changePasswordModal').style.display='flex';
  };
  document.getElementById('savePasswordBtn').onclick = () => {
    const cur = document.getElementById('currentPassword').value;
    const np = document.getElementById('newPassword').value;
    const cp = document.getElementById('confirmPassword').value;
    if(cur !== parentPassword){ alert('å½“å‰å¯†ç é”™è¯¯'); return }
    if(np.length < 4){ alert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº4ä½'); return }
    if(np !== cp){ alert('ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´'); return }
    parentPassword = np; saveAll();
    document.getElementById('changePasswordModal').style.display='none';
    document.getElementById('currentPassword').value='';
    document.getElementById('newPassword').value='';
    document.getElementById('confirmPassword').value='';
  };
  document.getElementById('cancelPasswordBtn').onclick = () => {
    document.getElementById('changePasswordModal').style.display='none';
  };

  // ====== å„¿ç«¥ç®¡ç†ä¸æ¸²æŸ“ ======
  document.getElementById('addChildBtn').onclick = () => {
    if(needAuth()) return; const name = document.getElementById('childName').value.trim();
    if(!name){ alert('è¯·è¾“å…¥å„¿ç«¥å§“å'); return }
    const child = { id: String(Date.now()), name, habits: { positive: JSON.parse(JSON.stringify(defaultPositive)), negative: JSON.parse(JSON.stringify(defaultNegative)) } };
    children.push(child); saveAll();
    renderAll(); switchTo(child.id); document.getElementById('childName').value='';
  };

  function renderTabs(){
    const el = document.getElementById('childrenList'); el.innerHTML='';
    children.forEach(c => {
      const tab = document.createElement('div'); tab.className='child-tab'; tab.dataset.childId=c.id;
      tab.innerHTML = `<span class="child-name">${c.name}</span>
        <button class="edit-btn" title="ç¼–è¾‘">âœï¸</button>
        <button class="delete-btn" title="åˆ é™¤">ğŸ—‘ï¸</button>`;
      tab.onclick = () => switchTo(c.id);
      tab.querySelector('.edit-btn').onclick = (e)=>{ e.stopPropagation(); if(needAuth()) return; const name = prompt('ä¿®æ”¹å§“å', c.name); if(name){ c.name = name.trim(); saveAll(); renderAll(); switchTo(c.id); } };
      tab.querySelector('.delete-btn').onclick = (e)=>{ e.stopPropagation(); if(needAuth()) return; if(children.length<=1){ alert('è‡³å°‘ä¿ç•™ä¸€åå„¿ç«¥'); return } if(confirm('ç¡®å®šåˆ é™¤?')){ children = children.filter(x=>x.id!==c.id); saveAll(); localStorage.removeItem(KEY('checks:'+c.id)); renderAll(); if(children[0]) switchTo(children[0].id); } };
      el.appendChild(tab);
    });
  }

  function renderQuick(){
    const q = document.getElementById('quickView'); q.innerHTML='';
    children.forEach(c => {
      const total = calcChildTotal(c.id);
      const card = document.createElement('div'); card.className='child-card'; card.dataset.childId=c.id;
      card.innerHTML = `<h3>${c.name}</h3><div class="child-points" style="color:${total>=0?'#4caf50':'#f44336'}">${total>=0?'+':''}${total}åˆ†</div><div class="child-habits">${c.habits.positive.length}ä¸ªå¥½ä¹ æƒ¯ | ${c.habits.negative.length}ä¸ªåä¹ æƒ¯</div>`;
      card.onclick = ()=>switchTo(c.id);
      q.appendChild(card);
    });
  }

  function renderScoreboard(child){
    const wrap = document.getElementById('scoreboardsContainer');
    const old = document.getElementById('scoreboard-'+child.id); if(old) old.remove();
    const div = document.createElement('div'); div.className='child-scoreboard'; div.id='scoreboard-'+child.id;
    div.innerHTML = `
      <div class="date-section">
        <label for="recordDate-${child.id}">è®°å½•æ—¥æœŸï¼š</label>
        <input type="date" id="recordDate-${child.id}">
      </div>
      <div class="points-summary">
        <div class="points-item"><div>æœ¬å‘¨æ€»åˆ†</div><div class="points-value total-points" id="totalPoints-${child.id}">0</div></div>
        <div class="points-item"><div>åŠ åˆ†é¡¹</div><div class="points-value positive-points" id="positivePoints-${child.id}">0</div></div>
        <div class="points-item"><div>å‡åˆ†é¡¹</div><div class="points-value negative-points" id="negativePoints-${child.id}">0</div></div>
      </div>
      <div class="section-card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><strong>ä¸€ã€åŠ åˆ†å¥–åŠ± ğŸŒŸ</strong><button class="add-habit-btn" data-type="positive" data-child="${child.id}">+ æ·»åŠ å¥½ä¹ æƒ¯</button></div>
        <table><thead><tr><th>å¥½ä¹ æƒ¯</th><th>ç§¯åˆ†</th><th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th><th>æ“ä½œ</th></tr></thead><tbody id="positiveHabits-${child.id}"></tbody></table>
      </div>
      <div class="section-card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><strong>äºŒã€å‡åˆ†æƒ©ç½š ğŸ˜ </strong><button class="add-habit-btn" data-type="negative" data-child="${child.id}">+ æ·»åŠ åä¹ æƒ¯</button></div>
        <table><thead><tr><th>ä¸è‰¯è¡Œä¸º</th><th>ç§¯åˆ†</th><th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th><th>æ“ä½œ</th></tr></thead><tbody id="negativeHabits-${child.id}"></tbody></table>
      </div>`;
    wrap.appendChild(div);

    document.getElementById(`recordDate-${child.id}`).valueAsDate = new Date();
    renderHabits(child.id,'positive',child.habits.positive);
    renderHabits(child.id,'negative',child.habits.negative);

    div.querySelectorAll('.add-habit-btn').forEach(b=> b.onclick = () => { if(needAuth()) return; const type=b.dataset.type; const c = children.find(x=>x.id===child.id); const defName = type==='positive'?'æ–°å¥½ä¹ æƒ¯':'æ–°åä¹ æƒ¯'; const defPts = type==='positive'?3:-3; c.habits[type].push({name:defName,points:defPts}); saveAll(); renderScoreboard(c); renderQuick(); });

    loadChecks(child.id);
  }

  function renderHabits(childId,type,arr){
    const tb = document.getElementById(`${type}Habits-${childId}`); tb.innerHTML='';
    arr.forEach((h,idx)=>{
      const pointsDisp = type==='positive'?`+${h.points}`:h.points;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="habit-name">${h.name}</td>
        <td class="points-cell ${type==='positive'?'positive-points-cell':'negative-points-cell'}">${pointsDisp}</td>
        ${['mon','tue','wed','thu','fri','sat','sun'].map(d=>`<td class="check-cell"><input type="checkbox" data-points="${h.points}" data-day="${d}" data-child="${childId}"></td>`).join('')}
        <td class="habit-actions"><button class="habit-edit-btn" title="ç¼–è¾‘">âœï¸</button><button class="habit-delete-btn" title="åˆ é™¤">ğŸ—‘ï¸</button></td>`;
      tb.appendChild(tr);

      tr.querySelectorAll('input[type="checkbox"]').forEach((cb,i)=>{
        const day = cb.getAttribute('data-day');
        const name = tr.querySelector('.habit-name').textContent;
        const id = `cb_${childId}_${type}_${idx}_${day}`; // ç¨³å®šIDï¼Œé¿å…æ”¹åå¯¼è‡´å¤±è”
        cb.id = id;
        cb.onchange = () => { updateTotals(childId); saveCheck(cb); renderQuick(); };
      });

      tr.querySelector('.habit-edit-btn').onclick = () => {
        if(needAuth()) return;
        const newName = prompt('ä¹ æƒ¯åç§°', h.name);
        const newPts = Number(prompt('ç§¯åˆ†(æ­£è´Ÿæ•°)', h.points));
        if(!newName || Number.isNaN(newPts)) return;
        h.name = newName.trim(); h.points = newPts; saveAll(); renderHabits(childId,type,arr); updateTotals(childId); renderQuick();
      };
      tr.querySelector('.habit-delete-btn').onclick = () => {
        if(needAuth()) return;
        if(arr.length<=1){ alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªé¡¹ç›®'); return }
        if(confirm('ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®?')){ arr.splice(idx,1); saveAll(); renderHabits(childId,type,arr); updateTotals(childId); renderQuick(); }
      };
    });
  }

  function switchTo(childId){
    document.querySelectorAll('.child-card').forEach(c=>c.classList.remove('active'));
    const activeCard = document.querySelector(`.child-card[data-child-id="${childId}"]`); if(activeCard) activeCard.classList.add('active');
    document.querySelectorAll('.child-tab').forEach(t=>t.classList.remove('active'));
    const activeTab = document.querySelector(`.child-tab[data-child-id="${childId}"]`); if(activeTab) activeTab.classList.add('active');
    document.querySelectorAll('.child-scoreboard').forEach(s=>s.style.display='none');
    const sb = document.getElementById('scoreboard-'+childId); if(sb) sb.style.display='block';
  }

  function calcChildTotal(childId){
    let pos=0, neg=0;
    document.querySelectorAll(`#positiveHabits-${childId} input[type="checkbox"]:checked`).forEach(cb=> pos += parseInt(cb.getAttribute('data-points')) );
    document.querySelectorAll(`#negativeHabits-${childId} input[type="checkbox"]:checked`).forEach(cb=> neg += parseInt(cb.getAttribute('data-points')) );
    return pos + neg;
  }
  function updateTotals(childId){
    let pos=0, neg=0;
    document.querySelectorAll(`#positiveHabits-${childId} input[type="checkbox"]:checked`).forEach(cb=> pos += parseInt(cb.getAttribute('data-points')) );
    document.querySelectorAll(`#negativeHabits-${childId} input[type="checkbox"]:checked`).forEach(cb=> neg += parseInt(cb.getAttribute('data-points')) );
    document.getElementById(`positivePoints-${childId}`).textContent=pos;
    document.getElementById(`negativePoints-${childId}`).textContent=neg;
    document.getElementById(`totalPoints-${childId}`).textContent=pos+neg;
  }

  function renderAll(){
    document.getElementById('scoreboardsContainer').innerHTML='';
    renderTabs(); renderQuick(); children.forEach(renderScoreboard);
  }

  // ====== GitHub Gist åŒæ­¥ ======
  function buildSnapshot(){
    const checks = {};
    children.forEach(c => { checks[c.id] = safeGet(KEY('checks:'+c.id), {}) });
    return { version:2, children, archives, checks };
  }

  async function saveToGist(){
    const token = localStorage.getItem(GH_TOKEN_KEY);
    if(!token){ document.getElementById('tokenModal').style.display='flex'; alert('è¯·å…ˆè®¾ç½® GitHub Token'); return }
    const gistIdInput = document.getElementById('gistId');
    const gistId = gistIdInput.value.trim() || localStorage.getItem(GH_GIST_ID_KEY) || '';

    const payload = {
      description: 'Habit table snapshot (auto-sync) â€” generated by browser',
      public: false,
      files: {
        'habit-data.json': { content: JSON.stringify(buildSnapshot(), null, 2) }
      }
    };

    const headers = { 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` };
    const url = gistId ? `https://api.github.com/gists/${gistId}` : 'https://api.github.com/gists';
    const method = gistId ? 'PATCH' : 'POST';

    try{
      const res = await fetch(url, { method, headers, body: JSON.stringify(payload) });
      if(!res.ok){ const t = await res.text(); throw new Error(`GitHub API é”™è¯¯ ${res.status}: ${t}`) }
      const data = await res.json();
      const newId = data.id;
      localStorage.setItem(GH_GIST_ID_KEY, newId);
      gistIdInput.value = newId;
      alert('å·²ä¿å­˜åˆ° Gistï¼š' + newId);
    }catch(e){ alert('ä¿å­˜å¤±è´¥ï¼š' + e.message); console.error(e); }
  }

  async function loadFromGist(){
    const gistIdInput = document.getElementById('gistId');
    const gistId = gistIdInput.value.trim() || localStorage.getItem(GH_GIST_ID_KEY);
    if(!gistId){ alert('è¯·è¾“å…¥æˆ–ä¿å­˜ä¸€ä¸ª Gist ID'); return }
    try{
      const res = await fetch(`https://api.github.com/gists/${gistId}`);
      if(!res.ok){ const t = await res.text(); throw new Error(`GitHub API é”™è¯¯ ${res.status}: ${t}`) }
      const data = await res.json();
      const file = data.files && (data.files['habit-data.json'] || Object.values(data.files)[0]);
      if(!file || !file.content) throw new Error('Gist ä¸­æœªæ‰¾åˆ° habit-data.json');
      const snapshot = JSON.parse(file.content);
      if(!snapshot.children) throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
      // è¦†ç›–æœ¬åœ°
      children = snapshot.children; archives = snapshot.archives || [];
      if(snapshot.checks){ Object.keys(snapshot.checks).forEach(id => safeSet(KEY('checks:'+id), snapshot.checks[id])); }
      saveAll(); renderAll(); if(children[0]) switchTo(children[0].id);
      localStorage.setItem(GH_GIST_ID_KEY, gistId);
      gistIdInput.value = gistId;
      alert('å·²ä» Gist åŠ è½½å®Œæˆ');
    }catch(e){ alert('åŠ è½½å¤±è´¥ï¼š' + e.message); console.error(e); }
  }

  // ç»‘å®š Gist æŒ‰é’®
  document.addEventListener('DOMContentLoaded', ()=>{
    const savedId = localStorage.getItem(GH_GIST_ID_KEY); if(savedId) document.getElementById('gistId').value = savedId;
    document.getElementById('btnSaveGist').onclick = saveToGist;
    document.getElementById('btnLoadGist').onclick = loadFromGist;
    document.getElementById('btnSetToken').onclick = ()=>{ document.getElementById('tokenModal').style.display='flex'; };
    document.getElementById('btnSaveToken').onclick = ()=>{ const v = document.getElementById('ghTokenInput').value.trim(); if(!v){ alert('Token ä¸èƒ½ä¸ºç©º'); return } localStorage.setItem(GH_TOKEN_KEY, v); alert('Token å·²ä¿å­˜åˆ°æœ¬æœº'); document.getElementById('tokenModal').style.display='none'; };
    document.getElementById('btnClearToken').onclick = ()=>{ localStorage.removeItem(GH_TOKEN_KEY); alert('å·²æ¸…é™¤ Token'); };
    document.getElementById('btnCloseToken').onclick = ()=>{ document.getElementById('tokenModal').style.display='none'; };
  });

  // ====== å¯¼å‡º / å¯¼å…¥ / å½’æ¡£ / åˆ†äº« ======
  document.getElementById('btnExport').onclick = () => {
    // æ•´ä½“å¿«ç…§
    const checks = {};
    children.forEach(c => { checks[c.id] = safeGet(KEY('checks:'+c.id), {}) });
    const snapshot = { version:2, children, archives, checks };
    download(`habit-snapshot-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(snapshot, null, 2));
  };

  document.getElementById('fileImport').onchange = (e) => {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = () => {
      try{
        const data = JSON.parse(r.result);
        if(!data || !data.children) throw new Error('æ ¼å¼ä¸æ­£ç¡®');
        children = data.children; archives = data.archives || [];
        // è¦†ç›– checks
        if(data.checks){ Object.keys(data.checks).forEach(id => safeSet(KEY('checks:'+id), data.checks[id])); }
        saveAll(); renderAll(); if(children[0]) switchTo(children[0].id);
        alert('å¯¼å…¥å®Œæˆ');
      }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼š'+ err.message); }
    }; r.readAsText(f);
    e.target.value = '';
  };

  document.getElementById('btnArchive').onclick = () => {
    const week = isoWeekStart();
    const rows = children.map(c => ({ id:c.id, name:c.name, total: calcChildTotal(c.id), positive: parseInt(document.getElementById(`positivePoints-${c.id}`).textContent)||0, negative: parseInt(document.getElementById(`negativePoints-${c.id}`).textContent)||0 }));
    const checks = {}; children.forEach(c => checks[c.id] = safeGet(KEY('checks:'+c.id), {}));
    archives.push({ weekStart: week, snapshot: { children: rows, raw: { children: JSON.parse(JSON.stringify(children)), checks } } });
    saveAll(); alert('å·²å½’æ¡£æœ¬å‘¨å¿«ç…§ï¼š' + week);
  };

  document.getElementById('btnHistory').onclick = () => {
    const body = document.getElementById('historyBody'); body.innerHTML='';
    archives.slice().reverse().forEach(a => {
      a.snapshot.children.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${a.weekStart}</td><td>${row.name}</td><td>${row.total}</td><td><button data-week="${a.weekStart}" data-id="${row.id}">æ¢å¤åˆ°å½“å‰</button></td>`;
        body.appendChild(tr);
      });
    });
    document.querySelectorAll('#historyBody button').forEach(btn => btn.onclick = () => {
      if(needAuth()) return;
      const wk = btn.getAttribute('data-week');
      const rec = archives.find(x=>x.weekStart===wk);
      if(!rec) return;
      if(!confirm('ç¡®è®¤å°†è¯¥å‘¨å¿«ç…§æ¢å¤ä¸ºå½“å‰æ•°æ®ï¼Ÿ')) return;
      // æ¢å¤ raw
      children = JSON.parse(JSON.stringify(rec.snapshot.raw.children));
      const checks = rec.snapshot.raw.checks || {};
      Object.keys(checks).forEach(id => safeSet(KEY('checks:'+id), checks[id]));
      saveAll(); renderAll(); if(children[0]) switchTo(children[0].id);
    });
    document.getElementById('historyModal').style.display='flex';
  };
  document.getElementById('btnCloseHistory').onclick = () => { document.getElementById('historyModal').style.display='none'; };
  document.getElementById('btnExportHistory').onclick = () => { download('habit-archives.json', JSON.stringify(archives, null, 2)); };

  document.getElementById('btnShare').onclick = () => {
    // ç”Ÿæˆå¯åˆ†äº«é“¾æ¥ï¼šå°†ç²¾ç®€å¿«ç…§æ”¾åˆ° URL hash
    const checks = {}; children.forEach(c => checks[c.id] = safeGet(KEY('checks:'+c.id), {}));
    const payload = { v:2, children, checks };
    const raw = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(payload)))));
    const url = location.origin + location.pathname + '#data=' + raw;
    navigator.clipboard?.writeText(url);
    alert('å·²ç”Ÿæˆå¹¶å¤åˆ¶é“¾æ¥ï¼Œç²˜è´´åˆ°æ–°è®¾å¤‡æµè§ˆå™¨å³å¯åŠ è½½');
  };
  // å¦‚å­˜åœ¨ #dataï¼Œæç¤ºå¯¼å…¥
  (function tryLoadFromHash(){
    const h = location.hash; if(!h.startsWith('#data=')) return;
    try{
      const raw = decodeURIComponent(h.slice(6));
      const json = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(raw)))));
      if(json && json.children){
        if(confirm('æ£€æµ‹åˆ°åˆ†äº«æ•°æ®ï¼Œæ˜¯å¦å¯¼å…¥å½“å‰é¡µé¢ï¼Ÿ')){
          children = json.children; Object.keys(json.checks||{}).forEach(id => safeSet(KEY('checks:'+id), json.checks[id]));
          saveAll(); renderAll(); if(children[0]) switchTo(children[0].id);
          location.hash = '';
        }
      }
    }catch(e){ console.warn('hash å¯¼å…¥å¤±è´¥', e); }
  })();

  document.getElementById('btnClear').onclick = () => {
    if(needAuth()) return;
    if(!confirm('æ­¤æ“ä½œä¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
    const keys = Object.keys(localStorage).filter(k=>k.startsWith(NS+':'));
    keys.forEach(k=>localStorage.removeItem(k));
    parentPassword = '123456'; children = []; archives = [];
    // é»˜è®¤æ·»åŠ ä¸€åå„¿ç«¥
    const child = { id: String(Date.now()), name: 'å°æ˜', habits: { positive: JSON.parse(JSON.stringify(defaultPositive)), negative: JSON.parse(JSON.stringify(defaultNegative)) } };
    children.push(child); saveAll(); renderAll(); switchTo(child.id);
  };

  // ====== é‡ç½®ä¸æ‰“å° ======
  document.getElementById('resetBtn').onclick = () => {
    if(needAuth()) return;
    const active = document.querySelector('.child-tab.active'); if(!active){ alert('è¯·é€‰æ‹©å„¿ç«¥'); return }
    const childId = active.dataset.childId;
    if(!confirm('ç¡®å®šé‡ç½®æœ¬å‘¨è¯¥å„¿ç«¥çš„æ‰€æœ‰å‹¾é€‰è®°å½•ï¼Ÿ')) return;
    document.querySelectorAll(`#scoreboard-${childId} input[type="checkbox"]`).forEach(cb=>{ cb.checked=false; saveCheck(cb); });
    updateTotals(childId); renderQuick();
  };
  document.getElementById('printBtn').onclick = () => window.print();

  // ====== åˆå§‹åŒ– ======
  if(children.length === 0){
    children.push({ id:String(Date.now()), name:'å°æ˜', habits:{ positive: JSON.parse(JSON.stringify(defaultPositive)), negative: JSON.parse(JSON.stringify(defaultNegative)) } });
  }
  renderAll(); switchTo(children[0].id); updateLock();

  // ====== PWA ç¼“å­˜ï¼ˆå¯é€‰ï¼‰ï¼šç¦»çº¿å¯ç”¨ ======
  if('serviceWorker' in navigator){
    try{ navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
      self.addEventListener('install', e=>{ e.waitUntil(caches.open('habit-cache-v1').then(c=>c.addAll(['./']))); });
      self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))); });
    `],{type:'text/javascript'}))); }catch(e){ console.warn('SW æ³¨å†Œå¤±è´¥', e); }
  }
  </script>
  <!-- Google Drive ClientID å¼¹çª— -->
  <div class="modal" id="driveModal">
    <div class="modal-content">
      <h3>è®¾ç½® Google OAuth Client ID</h3>
      <div style="font-size:.9rem;color:#666;margin:6px 0 10px">åˆ° Google Cloud åˆ›å»º <strong>OAuth 2.0 Client IDï¼ˆWeb åº”ç”¨ï¼‰</strong>ï¼Œæˆæƒ JavaScript æ¥æºå¡«ä½ çš„ GitHub Pages åŸŸåã€‚</div>
      <input type="text" id="driveClientIdInput" placeholder="ç²˜è´´ä½ çš„ Google OAuth Client ID" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"/>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="btnSaveDriveClient" class="success">ä¿å­˜</button>
        <button id="btnCloseDriveClient">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Google Drive åŒæ­¥ ======
    const DRIVE_CLIENT_ID_KEY = KEY('gdrive_client_id');
    const DRIVE_FILE_ID_KEY   = KEY('gdrive_file_id');
    let googleAccessToken = null;

    function loadGis(){
      return new Promise((resolve)=>{
        if(window.google && google.accounts) return resolve();
        const s = document.createElement('script');
        s.src = 'https://accounts.google.com/gsi/client';
        s.async = true; s.onload = resolve; document.head.appendChild(s);
      });
    }

    async function getAccessToken(){
      await loadGis();
      const clientId = localStorage.getItem(DRIVE_CLIENT_ID_KEY);
      if(!clientId){ document.getElementById('driveModal').style.display='flex'; throw new Error('æœªè®¾ç½® Google Client ID'); }
      return new Promise((resolve)=>{
        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: 'https://www.googleapis.com/auth/drive.file',
          callback: (t)=>{ googleAccessToken = t.access_token; resolve(googleAccessToken); }
        });
        tokenClient.requestAccessToken({ prompt: 'consent' });
      });
    }

    function revokeGoogle(){
      if(!googleAccessToken) return alert('æœªç™»å½•æˆ–ä»¤ç‰Œå·²è¿‡æœŸ');
      google.accounts.oauth2.revoke(googleAccessToken, ()=>{});
      googleAccessToken = null;
      alert('å·²é€€å‡º Google æˆæƒ');
    }

    function buildMultipartBody(metadata, content){
      const boundary = '-------habits-' + Math.random().toString(16).slice(2);
      const pre = `--${boundary}
Content-Type: application/json; charset=UTF-8

${JSON.stringify(metadata)}
`;
      const mid = `--${boundary}
Content-Type: application/json

${content}
`;
      const end = `--${boundary}--`;
      return { body: pre + mid + end, boundary };
    }

    async function saveToDrive(){
      const token = await getAccessToken();
      const snapshot = JSON.stringify(buildSnapshot(), null, 2);
      let fileId = localStorage.getItem(DRIVE_FILE_ID_KEY);
      const metadata = { name:'habit-data.json', mimeType:'application/json' };
      const { body, boundary } = buildMultipartBody(metadata, snapshot);
      const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'multipart/related; boundary=' + boundary };
      const url = fileId ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart` : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
      const method = fileId ? 'PATCH' : 'POST';
      const res = await fetch(url, { method, headers, body });
      if(!res.ok){ throw new Error(await res.text()); }
      const data = await res.json();
      localStorage.setItem(DRIVE_FILE_ID_KEY, data.id);
      alert('å·²ä¿å­˜åˆ° Google Driveï¼š' + data.id);
    }

    async function findDriveFileId(token){
      const q = encodeURIComponent("name='habit-data.json' and trashed=false");
      const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)`, { headers: { 'Authorization': 'Bearer ' + token } });
      if(!res.ok) throw new Error(await res.text());
      const data = await res.json();
      return (data.files && data.files[0] && data.files[0].id) || null;
    }

    async function loadFromDrive(){
      const token = await getAccessToken();
      let fileId = localStorage.getItem(DRIVE_FILE_ID_KEY);
      if(!fileId){ fileId = await findDriveFileId(token); if(!fileId) throw new Error('Drive ä¸­æœªæ‰¾åˆ° habit-data.json'); localStorage.setItem(DRIVE_FILE_ID_KEY, fileId); }
      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: { 'Authorization': 'Bearer ' + token } });
      if(!res.ok) throw new Error(await res.text());
      const snapshot = await res.json();
      if(!snapshot.children) throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
      // åº”ç”¨
      children = snapshot.children; archives = snapshot.archives || [];
      if(snapshot.checks){ Object.keys(snapshot.checks).forEach(id => safeSet(KEY('checks:'+id), snapshot.checks[id])); }
      saveAll(); renderAll(); if(children[0]) switchTo(children[0].id);
      alert('å·²ä» Google Drive åŠ è½½å®Œæˆ');
    }

    // ç»‘å®šæŒ‰é’®
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('btnGoogleClient').onclick = ()=>{ document.getElementById('driveModal').style.display='flex'; };
      document.getElementById('btnGoogleSignIn').onclick = ()=>{ getAccessToken().catch(e=>alert(e.message)); };
      document.getElementById('btnGoogleSignOut').onclick = revokeGoogle;
      document.getElementById('btnSaveDrive').onclick = ()=>{ saveToDrive().catch(e=>alert('ä¿å­˜å¤±è´¥ï¼š'+e.message)); };
      document.getElementById('btnLoadDrive').onclick = ()=>{ loadFromDrive().catch(e=>alert('åŠ è½½å¤±è´¥ï¼š'+e.message)); };

      const savedCid = localStorage.getItem(DRIVE_CLIENT_ID_KEY);
      if(savedCid) document.getElementById('driveClientIdInput').value = savedCid;
      document.getElementById('btnSaveDriveClient').onclick = ()=>{ const v = document.getElementById('driveClientIdInput').value.trim(); if(!v){ alert('Client ID ä¸èƒ½ä¸ºç©º'); return } localStorage.setItem(DRIVE_CLIENT_ID_KEY, v); alert('å·²ä¿å­˜ Client ID'); document.getElementById('driveModal').style.display='none'; };
      document.getElementById('btnCloseDriveClient').onclick = ()=>{ document.getElementById('driveModal').style.display='none'; };
    });
  </script>
  <!-- Microsoft OneDrive ClientID å¼¹çª— -->
  <div class="modal" id="msModal">
    <div class="modal-content">
      <h3>è®¾ç½® Microsoft åº”ç”¨ Client ID</h3>
      <div style="font-size:.9rem;color:#666;margin:6px 0 10px">åœ¨ Azure Portal åˆ›å»º <strong>å•é¡µåº”ç”¨</strong>ï¼Œé‡å®šå‘ URI å¡«ä½ çš„ GitHub Pages åŸŸåã€‚æœ€ä½éœ€è¦ <code>Files.ReadWrite</code> æƒé™ã€‚</div>
      <input type="text" id="msClientIdInput" placeholder="ç²˜è´´ä½ çš„ Microsoft åº”ç”¨ (Client) ID" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"/>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="btnSaveMsClient" class="success">ä¿å­˜</button>
        <button id="btnCloseMsClient">å…³é—­</button>
      </div>
    </div>
  </div>

  <style>.toolbar .ms{background:#2e7d32;color:#fff}</style>
  <script>
    // ====== OneDrive åŒæ­¥ï¼ˆMicrosoft Graphï¼‰======
    const MS_CLIENT_ID_KEY = KEY('ms_client_id');
    let msalClient = null;

    function loadMsal(){
      return new Promise((resolve)=>{
        if(window.msal){ return resolve(); }
        const s = document.createElement('script');
        s.src = 'https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js';
        s.async = true; s.onload = resolve; document.head.appendChild(s);
      });
    }

    async function initMsal(){
      await loadMsal();
      const clientId = localStorage.getItem(MS_CLIENT_ID_KEY);
      if(!clientId){ document.getElementById('msModal').style.display='flex'; throw new Error('æœªè®¾ç½® Microsoft Client ID'); }
      if(!msalClient){
        msalClient = new msal.PublicClientApplication({ auth:{ clientId, authority:'https://login.microsoftonline.com/common' } });
      }
      return msalClient;
    }

    async function msAcquireToken(){
      await initMsal();
      const scopes = ['User.Read','Files.ReadWrite','offline_access'];
      const accounts = msalClient.getAllAccounts();
      try{
        if(accounts.length){
          const res = await msalClient.acquireTokenSilent({ scopes, account: accounts[0] });
          return res.accessToken;
        }
      }catch(e){ }
      const res = await msalClient.loginPopup({ scopes });
      const token = await msalClient.acquireTokenSilent({ scopes, account: res.account });
      return token.accessToken;
    }

    async function msSignIn(){ try{ await msAcquireToken(); alert('å·²ç™»å½• Microsoft'); }catch(e){ alert(e.message); } }
    async function msSignOut(){ try{ await initMsal(); const acc = msalClient.getAllAccounts()[0]; if(acc){ await msalClient.logoutPopup({ account: acc }); alert('å·²é€€å‡º Microsoft'); } else { alert('æœªç™»å½•'); } }catch(e){ alert(e.message); } }

    function msGraph(url, options){ return fetch('https://graph.microsoft.com/v1.0' + url, options); }

    async function saveToOneDrive(){
      const token = await msAcquireToken();
      const snapshot = JSON.stringify(buildSnapshot(), null, 2);
      const res = await msGraph('/me/drive/root:/habit-data.json:/content', {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type':'application/json' },
        body: snapshot
      });
      if(!res.ok){ throw new Error(await res.text()); }
      alert('å·²ä¿å­˜åˆ° OneDrive');
    }

    async function loadFromOneDrive(){
      const token = await msAcquireToken();
      const meta = await msGraph('/me/drive/root:/habit-data.json', { headers:{ 'Authorization':'Bearer ' + token } });
      if(meta.status === 404){ throw new Error('OneDrive ä¸­æœªæ‰¾åˆ° habit-data.json'); }
      if(!meta.ok){ throw new Error(await meta.text()); }
      const m = await meta.json();
      const dl = await fetch(m['@microsoft.graph.downloadUrl']);
      if(!dl.ok){ throw new Error('ä¸‹è½½å¤±è´¥'); }
      const snapshot = await dl.json();
      if(!snapshot.children) throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
      children = snapshot.children; archives = snapshot.archives || [];
      if(snapshot.checks){ Object.keys(snapshot.checks).forEach(id => safeSet(KEY('checks:'+id), snapshot.checks[id])); }
      saveAll(); renderAll(); if(children[0]) switchTo(children[0].id);
      alert('å·²ä» OneDrive åŠ è½½å®Œæˆ');
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const savedMid = localStorage.getItem(MS_CLIENT_ID_KEY);
      if(savedMid){ const i = document.getElementById('msClientIdInput'); if(i) i.value = savedMid; }
      document.getElementById('btnMsClient').onclick = ()=>{ document.getElementById('msModal').style.display='flex'; };
      document.getElementById('btnSaveMsClient').onclick = ()=>{ const v = document.getElementById('msClientIdInput').value.trim(); if(!v){ alert('Client ID ä¸èƒ½ä¸ºç©º'); return } localStorage.setItem(MS_CLIENT_ID_KEY, v); alert('å·²ä¿å­˜ Microsoft Client ID'); document.getElementById('msModal').style.display='none'; };
      document.getElementById('btnCloseMsClient').onclick = ()=>{ document.getElementById('msModal').style.display='none'; };
      document.getElementById('btnMsSignIn').onclick = ()=>{ msSignIn(); };
      document.getElementById('btnMsSignOut').onclick = ()=>{ msSignOut(); };
      document.getElementById('btnSaveOneDrive').onclick = ()=>{ saveToOneDrive().catch(e=>alert('ä¿å­˜å¤±è´¥ï¼š'+e.message)); };
      document.getElementById('btnLoadOneDrive').onclick = ()=>{ loadFromOneDrive().catch(e=>alert('åŠ è½½å¤±è´¥ï¼š'+e.message)); };
    });
  </script>
  <!-- Microsoft ClientID å¼¹çª— -->
  <div class="modal" id="msModal">
    <div class="modal-content">
      <h3>è®¾ç½® Microsoft OAuth Client ID</h3>
      <div style="font-size:.9rem;color:#666;margin:6px 0 10px">åˆ° Azure Portal åˆ›å»º <strong>å•é¡µåº”ç”¨ (SPA)</strong>ã€‚é‡å®šå‘ URI å¡«ä½ çš„ GitHub Pages åŸŸåï¼Œä¾‹å¦‚ <code>https://ç”¨æˆ·å.github.io/</code>ã€‚æˆäºˆä½œç”¨åŸŸï¼š<code>Files.ReadWrite.AppFolder</code>ã€‚</div>
      <input type="text" id="msClientIdInput" placeholder="ç²˜è´´ä½ çš„ Microsoft åº”ç”¨ Client ID" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"/>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="btnSaveMsClient" class="success">ä¿å­˜</button>
        <button id="btnCloseMsClient">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    // ====== OneDrive åŒæ­¥ï¼ˆMicrosoft Graph + MSAL æµè§ˆå™¨ï¼‰ ======
    const MS_CLIENT_ID_KEY = KEY('ms_client_id');
    const MS_FILE_PATH = "/me/drive/special/approot:/habit-data.json:/content"; // App ä¸“å±ç›®å½•
    let msalApp = null;
    let msAccessToken = null;

    function loadMsal(){
      return new Promise((resolve)=>{
        if(window.msal) return resolve();
        const s = document.createElement('script');
        s.src = 'https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js';
        s.async = true; s.onload = resolve; document.head.appendChild(s);
      });
    }

    async function ensureMsal(){
      await loadMsal();
      if(msalApp) return msalApp;
      const clientId = localStorage.getItem(MS_CLIENT_ID_KEY);
      if(!clientId){ document.getElementById('msModal').style.display='flex'; throw new Error('æœªè®¾ç½® Microsoft Client ID'); }
      msalApp = new msal.PublicClientApplication({
        auth: { clientId, authority: 'https://login.microsoftonline.com/common' },
        cache: { cacheLocation: 'localStorage' }
      });
      return msalApp;
    }

    async function getMsToken(){
      await ensureMsal();
      const request = { scopes: ['Files.ReadWrite.AppFolder'] };
      try{
        const accounts = msalApp.getAllAccounts();
        if(accounts.length){
          const res = await msalApp.acquireTokenSilent({ ...request, account: accounts[0] });
          msAccessToken = res.accessToken; return msAccessToken;
        }
      }catch(e){ /* ignore silent failure */ }
      const loginRes = await msalApp.loginPopup({ scopes: ['Files.ReadWrite.AppFolder'] });
      const tokenRes = await msalApp.acquireTokenSilent({ account: loginRes.account, scopes: ['Files.ReadWrite.AppFolder'] });
      msAccessToken = tokenRes.accessToken; return msAccessToken;
    }

    async function saveToOneDrive(){
      const token = await getMsToken();
      const snapshot = JSON.stringify(buildSnapshot(), null, 2);
      const res = await fetch('https://graph.microsoft.com/v1.0' + MS_FILE_PATH, {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: snapshot
      });
      if(!res.ok){ throw new Error(await res.text()); }
      alert('å·²ä¿å­˜åˆ° OneDrive åº”ç”¨ä¸“å±ç›®å½•');
    }

    async function loadFromOneDrive(){
      const token = await getMsToken();
      const res = await fetch('https://graph.microsoft.com/v1.0' + MS_FILE_PATH.replace(':/content', ''), {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if(res.status === 404){
        throw new Error('OneDrive æœªæ‰¾åˆ° habit-data.json');
      }
      if(!res.ok){ throw new Error(await res.text()); }
      // è·å–ä¸‹è½½é“¾æ¥
      const meta = await res.json();
      const dl = await fetch(meta['@microsoft.graph.downloadUrl']);
      const snapshot = await dl.json();
      if(!snapshot.children) throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
      children = snapshot.children; archives = snapshot.archives || [];
      if(snapshot.checks){ Object.keys(snapshot.checks).forEach(id => safeSet(KEY('checks:'+id), snapshot.checks[id])); }
      saveAll(); renderAll(); if(children[0]) switchTo(children[0].id);
      alert('å·²ä» OneDrive åŠ è½½å®Œæˆ');
    }

    function signOutMs(){ if(!msalApp){ alert('æœªç™»å½•'); return } msalApp.logoutPopup(); msAccessToken=null; alert('å·²é€€å‡ºå¾®è½¯è´¦æˆ·'); }

    // ç»‘å®šæŒ‰é’®
    document.addEventListener('DOMContentLoaded', ()=>{
      // è¯»å–å·²å­˜çš„ Client ID
      const saved = localStorage.getItem(MS_CLIENT_ID_KEY);
      if(saved) document.getElementById('msClientIdInput') && (document.getElementById('msClientIdInput').value = saved);

      document.getElementById('btnMsClient').onclick = ()=>{ document.getElementById('msModal').style.display='flex'; };
      document.getElementById('btnSaveMsClient').onclick = ()=>{ const v = document.getElementById('msClientIdInput').value.trim(); if(!v){ alert('Client ID ä¸èƒ½ä¸ºç©º'); return } localStorage.setItem(MS_CLIENT_ID_KEY, v); alert('å·²ä¿å­˜ Microsoft Client ID'); document.getElementById('msModal').style.display='none'; };
      document.getElementById('btnCloseMsClient').onclick = ()=>{ document.getElementById('msModal').style.display='none'; };

      document.getElementById('btnMsSignIn').onclick = ()=>{ getMsToken().catch(e=>alert(e.message)); };
      document.getElementById('btnMsSignOut').onclick = signOutMs;
      document.getElementById('btnSaveOneDrive').onclick = ()=>{ saveToOneDrive().catch(e=>alert('ä¿å­˜å¤±è´¥ï¼š'+e.message)); };
      document.getElementById('btnLoadOneDrive').onclick = ()=>{ loadFromOneDrive().catch(e=>alert('åŠ è½½å¤±è´¥ï¼š'+e.message)); };
    });
  </script>
</body>
</html>
